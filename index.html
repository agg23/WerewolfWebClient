<html>
    <head>
	    <title>Chat</title>
	    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
		<script src="socket.io.slim.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.21.1/babel.min.js"></script>
		<script type="text/babel">
		var socket = new WebSocket('wss://werewolf.thehome.stream/socket');
		var createUsername = '';
		var createPassword = '';
		var signInUsername = '';
		var signInPassword = '';
		var givenNickname = '';
		var joinGameID = '';
		var joinGamePassword = '';
		var hostGameName = '';
		var hostGamePassword = '';
		var charactersInPlay = [];
		var peoplePlayers = [];
		var peoplePlayersNames =[];
		var hostGameID = '';
		var clientsCurrentCharacter = '';
		var cards = [];
		var checkedArray = [];
		var submitType = '';

		jQuery(function($) {
			$( "#readyUpButton" ).click(function() {
				readyUp();
			});
			$( "#createAccountButton" ).click(function() {
				createAccount();
			});
			$( "#signInButton" ).click(function() {
				signIn();
			});
			$( "#nicknameButton" ).click(function() {
				setNickname();
			});
			$( "#hostGameButton" ).click(function() {
				hostGame();
			});
			$( "#joinGameButton" ).click(function() {
				joinGame();
			});
			$( "#submitActionsButton" ).click(function() {
				submitActions();
			});
		});

		function readyUp(){
		   	socket.send(JSON.stringify({'command' : 'ready'}));
		}
		function createAccount(){
			createUsername = $('#createUsername').val();
			createPassword = $('#createPassword').val();
		   	socket.send(JSON.stringify({'command' : 'createAccount', 'username' : createUsername, 'password' : createPassword}));
		}
		function signIn(){
			signInUsername = $('#signInUsername').val();
			signInPassword = $('#signInPassword').val();
		   	socket.send(JSON.stringify({'command' : 'signIn', 'username' : signInUsername, 'password' : signInPassword}));
		}
		function setNickname(){
			givenNickname = $('#givenNickname').val();
		   	socket.send(JSON.stringify({'command' : 'setNickname', 'nickname' : givenNickname}));
		}
		function hostGame(){
			hostGameName =  $('#hostGameName').val();
			hostGamePassword = $('#hostGamePassword').val();
			charactersInPlay = $('#hostGameCharacters').val().split(" ");
		   	socket.send(JSON.stringify({'command' : 'hostGame', 'name' : hostGameName, 'password' : hostGamePassword, 'inPlay' : charactersInPlay}));
		}
		function joinGame(){
			joinGameID =  $('#joinGameID').val();
			joinGamePassword = $('#joinGamePassword').val();
		   	socket.send(JSON.stringify({'command' : 'joinGame', 'id' : joinGameID, 'password' : joinGamePassword}));
		}
		function submitActions(){
			if(checkedArray.length == 1) {
				submitType = 'singleSelection';
			}
			else if (checkedArray.length == 2) {
				submitType = 'doubleSelection';
			}
		   	socket.send(JSON.stringify({'command' : 'select', 'type' : submitType, 'selections' : checkedArray, 'rotation' : 'null'}));
		   	console.log(JSON.stringify({'command' : 'select', 'type' : submitType, 'selections' : checkedArray, 'rotation' : 'null'}));
		}

		// Open the socket
		socket.onopen = function(event) {
			
			setInterval(function() {
				socket.send('__ping__');
			}, 5000);

			// Listen for messages
			socket.onmessage = function(event) {
				var parsedEvent = '';

				if(event.data == '__pong__') {

				}
				else {
					console.log('Client received a message',event);
					var parsedEvent = $.parseJSON(event.data);
				}
				if(parsedEvent.command == 'accountCreated') {
					console.log("Logged in as: " + data.username);
				}
				else if(parsedEvent.command == 'response' && parsedEvent.task == 'hostGame') {
					hostGameID = parsedEvent.data.id
					console.log('THIS IS THE GAME ID: ' + hostGameID)
				}
				else if(parsedEvent.command == 'gameUpdate') {
					charactersInPlay = parsedEvent.inPlay;
					document.getElementById("root2").innerHTML = "Characters in Play : " + charactersInPlay.map(function(item) {return item.name});
					peoplePlayers = parsedEvent.players;
					peoplePlayersNames = peoplePlayers.map(function(item) {return item.nickname});
					if(cards.length < peoplePlayers.length){
						cards = [];
						for (var n = 0; n < peoplePlayers.length; n++) { 
						    cards.push(n);
						}
					}

					class CheckBox extends React.Component {

					    // Input is set as a checkbox, with its ID, value and onChange set as properties
					    // The properties will be set when each instance is output
					    render() {
					        return (
					            <input type="checkbox" id={this.props.id} value={this.props.value} onChange={this.props.onChange} />
					        )
					    }

					}

					class Controls extends React.Component {

					    constructor(props) {
					        super(props);
					        this.state= { optionsChecked: [] }
					    }

					    changeEvent(event) {

					        // Gets the optionsChecked state which is an array by default
					        checkedArray = this.state.optionsChecked;

					        // Get the value of the checkbox that's been changed
					        let selectedValue = event.target.value;

					        // If statement to detect whether the checkbox has been selected or deselected
					        // If it's been selected push the value and updated the state with updated array
					        // If it's been deselected then remove the value from the array and update the state
					        if (event.target.checked === true) {

					            checkedArray.push(selectedValue);
					            this.setState({
					              optionsChecked: checkedArray
					            });

					        } else {

					            let valueIndex = checkedArray.indexOf(selectedValue);
					            checkedArray.splice(valueIndex, 1);

					            this.setState({
					              optionsChecked: checkedArray
					            });

					        }

					    }

					    render() {
					        // Loop to create checkboxes from CheckBox component
					        // Value property is set to array item value
					        // ID is set to the array item value_key to keep it unique
					        // onChange is linked to changeEvent function
					        let outputCheckboxes = cards.map(function(string, i){
					            return (<div><CheckBox value={string} id={'string_' + i} onChange={this.changeEvent.bind(this)} /><label htmlFor={'string_' + i}>{string}</label></div>)
					        }, this);

					        return (
					            <div>
					              <div>
					                  {outputCheckboxes}
					              </div>
					              <div>
					                  {JSON.stringify(this.state.optionsChecked)}
					              </div>
					            </div>
					        )
					    }

					}


					ReactDOM.render(
							  <Controls />,
							  document.getElementById('root')
							);


					console.log("character in play: " + charactersInPlay.map(function(item) {return item.name}));
					console.log("humans connected: " + peoplePlayers.map(function(item) {return item.id + " : " + item.ready}));
				}
				else if(parsedEvent.command == 'characterUpdate') {
					clientsCurrentCharacter = parsedEvent.character;
					document.getElementById("root3").innerHTML = "I am the character : " + clientsCurrentCharacter.name;
					console.log("My new character is : " + clientsCurrentCharacter.name);
				}
				else if(parsedEvent.command == 'userSignedIn') {
					console.log("Logged in as: " + data.username);
				}
				else if(parsedEvent.command == 'gotNickname') {
					console.log("New nickname: " + data.nickname);
				}
				else if(parsedEvent.command == 'hostedGame') {
					 console.log("Now hosting a game: " + data.gameID);
				}
				else if(parsedEvent.command == 'joinedGame') {
					console.log("Joined a game: " + data.gameID);
				}
				else if(parsedEvent.command == 'setCharacter') {
					console.log("You are the " + data);
				}
				else if(parsedEvent.command == 'allowedActions') {
					console.log("You are the " + data);
				}
				else if(parsedEvent.command == 'revealCard') {
					console.log("You are the " + data);
				}
				else if(parsedEvent.command == 'gameStarted') {
					console.log("You are the " + data);
				}
				else if(parsedEvent.command == 'gameResults') {
					console.log("You are the " + data);
				}
				
			};
			
			// Listen for socket closes
			socket.onclose = function(event) {
				console.log('Client notified socket has closed',event);
			};

		};
		</script>
    </head>
    <p>Welcome To Werewolf!!!</p>
    <body>
	    <div id="Page1">
		Username : <input size = "25" id="createUsername">
        Password : <input size = "25" id="createPassword" type = "password">
        Retype Password : <input size = "55" id="createRetypedPassword" type="password">
        <p id = "createAccountButton">SUBMIT THE CREATE ACCOUNT BY CLICKING ON ME</p>
		Username : <input size = "25" id="signInUsername">
        Password : <input size = "25" id="signInPassword" type="password">
        <p id = "signInButton">SUBMIT THE SIGN IN BY CLICKING ON ME</p>
		Set Nickname : <input size ="25" id="givenNickname"></input>
		<p id = "nicknameButton">SUBMIT THE NICKNAME BY CLICKING ON ME</p>
		Create a Game Name : <input size = "25" id="hostGameName">
        Create a Game Password : <input size = "25" id="hostGamePassword" type="password">
     	Choose the characters -- all undercase -- space delimitted : <input size = "140" id="hostGameCharacters">
        <p id = "hostGameButton">SUBMIT THE HOST GAME BY CLICKING ON ME</p>
		Game ID : <input size = "25" id="joinGameID">
        Game Password : <input size = "25" id="joinGamePassword" type = "password">
        <p id = "joinGameButton">SUBMIT THE JOIN GAME BY CLICKING ON ME</p>
        <p id = "readyUpButton">Ready Up!</p>
	    </div>
	    <div id = "root"></div>
	    <p id = "submitActionsButton">Submit Action</p>
	    <div id = "root2"></div>
	    <div id = "root3"></div>
    </body>
</html>