<html>
    <head>
	    <title>Chat</title>
	    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
		<script src="socket.io.slim.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.21.1/babel.min.js"></script>
		<script type="text/babel">
		var socket = new WebSocket('wss://werewolf.thehome.stream/socket');
		var createUsername = '';
		var createPassword = '';
		var createRetypedPassword = '';
		var signInUsername = '';
		var signInPassword = '';
		var givenNickname = '';
		var loggedInAs = '';
		var joinGameID = '';
		var joinGamePassword = '';
		var hostGameName = '';
		var hostGamePassword = '';
		var hostGameRetypedPassword = '';
		var charactersInPlay = [];
		var peoplePlayers = [];
		var peoplePlayersNames =[];
		var hostGameID = '';
		var clientsCurrentCharacter = '';
		var cards = [];
		var cardsWithChecked = []
		var checkedArray = [];
		var submitType = '';
		var myID = '';
		var myStartingCharacter = '';
		var allowedActions = '';

		jQuery(function($) {
			$( "#readyUpButton" ).click(function() {
				readyUp();
			});
			$( "#goToCreateAccount" ).click(function() {
				goToCreateAccount();
			});
			$( "#goToSignIn" ).click(function() {
				goToSignIn();
			});
			$( "#goToHostGame" ).click(function() {
				goToHostGame();
			});
			$( "#goToJoinGame" ).click(function() {
				goToJoinGame();
			});
			$( "#createAccountButton" ).click(function() {
				createAccount();
			});
			$( "#signInButton" ).click(function() {
				signIn();
			});
			$( "#nicknameButton" ).click(function() {
				setNickname();
			});
			$( "#hostGameButton" ).click(function() {
				hostGame();
			});
			$( "#joinGameButton" ).click(function() {
				joinGame();
			});
			$( "#submitActionsButton" ).click(function() {
				submitActions();
			});
		});

		function readyUp(){
			document.getElementById("areYouReady").innerHTML = "You are Ready!";
		   	socket.send(JSON.stringify({'command' : 'ready'}));
		}
		function goToCreateAccount(){
			document.getElementById("createAccountDiv").style.display = "block";
			document.getElementById("signInDiv").style.display = "none";
		}
		function goToSignIn(){
			document.getElementById("signInDiv").style.display = "block";
			document.getElementById("createAccountDiv").style.display = "none";
		}
		function goToHostGame(){
			document.getElementById("hostGameDiv").style.display = "block";
			document.getElementById("joinGameDiv").style.display = "none";
		}
		function goToJoinGame(){
			document.getElementById("joinGameDiv").style.display = "block";
			document.getElementById("hostGameDiv").style.display = "none";
		}
		function createAccount(){
			givenNickname = $('#givenNickname').val();
			createUsername = $('#createUsername').val();
			createPassword = $('#createPassword').val();
			createRetypedPassword = $('#createRetypedPassword').val();
			loggedInAs = $('#createUsername').val();
			if(createPassword != createRetypedPassword) {
				alert('passwords do not match');
			}
			else {
				socket.send(JSON.stringify({'command' : 'register', 'username' : createUsername, 'password' : createPassword, 'nickname' : givenNickname}));
				$("#givenNickname").val("");
				$("#createUsername").val("");
				$("#createPassword").val("");
				$("#createRetypedPassword").val("");
			}
		}
		function signIn(){
			signInUsername = $('#signInUsername').val();
			signInPassword = $('#signInPassword').val();
			loggedInAs = $('#signInUsername').val();
		   	socket.send(JSON.stringify({'command' : 'login', 'username' : signInUsername, 'password' : signInPassword}));
		   	$("#signInUsername").val("");
			$("#signInPassword").val("");
		}
		function setNickname(){
			givenNickname = $('#givenNickname').val();
		   	socket.send(JSON.stringify({'command' : 'setNickname', 'nickname' : givenNickname}));
		}
		function hostGame(){
			hostGameName =  $('#hostGameStartingID').val();
			hostGamePassword = $('#hostGamePassword').val();
			hostGameRetypedPassword = $('#hostGameRetypedPassword').val();
			charactersInPlay = $('#hostGameCharacters').val().split(" ");
		   	socket.send(JSON.stringify({'command' : 'hostGame', 'name' : hostGameName, 'password' : hostGamePassword, 'inPlay' : charactersInPlay}));
		}
		function joinGame(){
			joinGameID =  $('#joinGameID').val();
			joinGamePassword = $('#joinGamePassword').val();
			console.log(JSON.stringify({'command' : 'joinGame', 'id' : joinGameID, 'password' : joinGamePassword}));
		   	socket.send(JSON.stringify({'command' : 'joinGame', 'id' : joinGameID, 'password' : joinGamePassword}));
		}
		function submitActions(){
			if(checkedArray.length == 1) {
				submitType = 'singleSelection';
			}
			else if (checkedArray.length == 2) {
				submitType = 'doubleSelection';
			}
		   	socket.send(JSON.stringify({'command' : 'select', 'type' : submitType, 'selections' : checkedArray, 'rotation' : 'null'}));
		}
		

		// Open the socket
		socket.onopen = function(event) {
			
			setInterval(function() {
				socket.send('__ping__');
			}, 5000);

			// Listen for messages
			socket.onmessage = function(event) {
				var parsedEvent = '';

				if(event.data == '__pong__') {

				}
				else {
					var parsedEvent = $.parseJSON(event.data);
					console.log(event);
				}
				if(parsedEvent.command == 'response' && (parsedEvent.task == 'register' || parsedEvent.task == 'login') && parsedEvent.status == 'success') {
					document.getElementById("createAccountDiv").style.display = "none";
					document.getElementById("signInDiv").style.display = "none";
					document.getElementById("createAccountOrLoginDiv").style.display = "none";
					document.getElementById("createOrJoinGameDiv").style.display = "block";
					document.getElementById("loggedInAs").innerHTML = "Logged In As: " + loggedInAs;
					document.getElementById("root7").innerHTML = "Available Characters : " + parsedEvent.data.availableCharacters;
					myID = parsedEvent.data.id;
				}
				else if(parsedEvent.command == 'accountCreated') {
					console.log("Logged in as: " + data.username);
				}
				else if(parsedEvent.command == 'response' && parsedEvent.state == 'lobby') {
					hostGameID = parsedEvent.data.id;
					console.log('THIS IS THE GAME ID: ' + hostGameID);
				}
				else if(parsedEvent.command == 'response' && parsedEvent.task == 'hostGame' && parsedEvent.status == 'success') {
					hostGameID = parsedEvent.data.id;
					console.log('THIS IS THE GAME ID: ' + hostGameID);
				}
				else if(parsedEvent.command == 'gameUpdate') {
					peoplePlayers = parsedEvent.players;
					charactersInPlay = parsedEvent.inPlay;
					if(peoplePlayers.length + 3 == charactersInPlay.length) {
						document.getElementById("readyUpButtonDiv").style.display = "block";
					}
					document.getElementById("usersReadiedUp").innerHTML = "Number of Players Connected: " + peoplePlayers.length;
					document.getElementById("usersReadiedUp").style.display = "block";
					document.getElementById("createOrJoinGameDiv").style.display = "none";
					document.getElementById("joinGameDiv").style.display = "none";
					document.getElementById("hostGameDiv").style.display = "none";
					document.getElementById("root2").innerHTML = "Characters in Play : " + charactersInPlay.map(function(item) {return item.name});
					console.log("THIS IS HOW I GET PEOPLEPLAYERS ORIGINALLY :: " + peoplePlayers[0].id);
					peoplePlayers.forEach(function(obj) { obj.src = "vanguard.jpg"});
					peoplePlayers.forEach(function(obj) { 
					if(obj.id == myID) {
						obj.src = "lol.jpg";
					}
					});
					document.getElementById("root").style.display = "block";

					if (parsedEvent.state == 'night' || parsedEvent.state == 'discussion') {
						if (parsedEvent.state == 'discussion') {
							document.getElementById("root8").innerHTML = "It is now the discussion phase!!!";
						}

						class CheckBox extends React.Component {

						    // Input is set as a checkbox, with its ID, value and onChange set as properties
						    // The properties will be set when each instance is output
						    render() {
						        return (
						            <input type="image" src={this.props.src} id={this.props.id} value={this.props.value} onClick={this.props.onClick} width="100" height="150" />
						        )
						    }

						}

						class Controls extends React.Component {

						    constructor(props) {
						        super(props);
						        this.state= { optionsChecked: [] }
						    }

						    changeEvent(event) {
						    	if(event.target.id == "submitButton") {
						    		submitActions();
						    		console.log("I AM WORKING");
						    		this.state.optionsChecked = [];
						    		return;
						    	}
						        var isHuman = '';
						        peoplePlayers.map(function(item) {if(event.target.id == item.id){isHuman = item.isHuman;}});
						        console.log(allowedActions.selectionCount);
						        if((allowedActions.selectionType == 'all' || (allowedActions.selectionType == 'humanOnly' && isHuman)
						        || (allowedActions.selectionType == 'nonHumanOnly' && !isHuman)) && allowedActions.selectionCount > 0) {

						        	allowedActions.selectionCount = allowedActions.selectionCount - 1;
							        if(event.target.style.border == "") {
							        	event.target.style.border = "10px solid blue";
							        }
							        else {
							        	event.target.style.border = "";
							        }

							        checkedArray = this.state.optionsChecked;

							        // Get the value of the checkbox that's been changed
							        let selectedValue = event.target.value;

						        	if(checkedArray.includes(parseInt(selectedValue))) {
						        		var indexToRemove = checkedArray.indexOf(parseInt(selectedValue));
						        		if (indexToRemove > -1) {
										    checkedArray.splice(indexToRemove, 1);
										}
						        	}
						        	else {
						        		checkedArray.push(parseInt(selectedValue));
						        	}
						            this.setState({
						              optionsChecked: checkedArray
						            });
						        }
						        else if (checkedArray.includes(parseInt(event.target.value))){
						        	event.target.style.border = "";
						        	allowedActions.selectionCount = allowedActions.selectionCount + 1;

						        	checkedArray = this.state.optionsChecked;

							        // Get the value of the checkbox that's been changed
							        let selectedValue = event.target.value;

						        	if(checkedArray.includes(parseInt(selectedValue))) {
						        		var indexToRemove = checkedArray.indexOf(parseInt(selectedValue));
						        		if (indexToRemove > -1) {
										    checkedArray.splice(indexToRemove, 1);
										}
						        	}
						        	else {
						        		checkedArray.push(parseInt(selectedValue));
						        	}
						            this.setState({
						              optionsChecked: checkedArray
						            });
						        }
						        console.log(allowedActions.selectionCount);
						    }

						    render() {
						        // Loop to create checkboxes from CheckBox component
						        // Value property is set to array item value
						        // ID is set to the array item value_key to keep it unique
						        // onChange is linked to changeEvent function
						        let outputCheckboxes = peoplePlayers.map(function(string, i){
						            return (<div><CheckBox src={string.src} value={string.id} id={string.id} onClick={this.changeEvent.bind(this)}/><br></br><label id="myString" htmlFor={'string_' + i}>{"ID : " + string.id + ".  isHuman : " + string.isHuman + ".  nickname : " + string.nickname}</label></div>)
						        }, this);
						        var submitJSON = {src:"submit.png", id:"submitButton"};
						        console.log(submitJSON);
						        console.log(peoplePlayers);
						      	
						        return (
						            <div>
						              <div>
						                  {outputCheckboxes}
						              </div>
						              <div>
						                  {JSON.stringify(this.state.optionsChecked)}
						              </div>
						              <div><CheckBox src={submitJSON.src} value={submitJSON.id} id={submitJSON.id} onClick={this.changeEvent.bind(this)} /></div>
						            </div>
						        )
						    }

						}


						ReactDOM.render(
								  <Controls />,
								  document.getElementById('root')
								);
						}
				}
				else if(parsedEvent.command == 'characterUpdate') {
					clientsCurrentCharacter = parsedEvent.character;
					document.getElementById("root3").innerHTML = "I am the character : " + clientsCurrentCharacter.name;
					document.getElementById("root4").innerHTML = "I have seen these cards : " + parsedEvent.seenAssignments.map(function(item) {return item.id + " : " + item.character});
					allowedActions = clientsCurrentCharacter.allowedActions
					myStartingCharacter = clientsCurrentCharacter.name;
				}
				else if(parsedEvent.command == 'userSignedIn') {
					console.log("Logged in as: " + data.username);
				}
				else if(parsedEvent.command == 'gotNickname') {
					console.log("New nickname: " + data.nickname);
				}
				else if(parsedEvent.command == 'hostedGame') {
					 console.log("Now hosting a game: " + data.gameID);
				}
				else if(parsedEvent.command == 'joinedGame') {
					console.log("Joined a game: " + data.gameID);
				}
				else if(parsedEvent.command == 'setCharacter') {
					console.log("You are the " + data);
				}
				else if(parsedEvent.command == 'allowedActions') {
					console.log("You are the " + data);
				}
				else if(parsedEvent.command == 'revealCard') {
					console.log("You are the " + data);
				}
				else if(parsedEvent.command == 'gameStarted') {
					console.log("You are the " + data);
				}
				else if(parsedEvent.command == 'gameResults') {
					document.getElementById("root9").innerHTML = "Game Results : " + parsedEvent.assignments.map(function(item) {return item.id + " : " + item.character});
				}
				
			};
			
			// Listen for socket closes
			socket.onclose = function(event) {
				console.log('Client notified socket has closed',event);
			};

		};
		</script>
    </head>
    <p>Welcome To Werewolf!!!</p>
    <p id="loggedInAs"></p>
    <body>
    	<div id= "createAccountOrLoginDiv">
	    	<button id = "goToCreateAccount">Create Account</button>
	    	<button id = "goToSignIn">Sign In</button><br></br>
	    </div>
	    	<div id= "createOrJoinGameDiv" style = "display: none">
	    	<button id = "goToHostGame">Host Game</button>
	    	<button id = "goToJoinGame">Join Game</button><br></br>
	    </div>
	    <div id="createAccountDiv" style = "display: none">
	    	Nickname: <input size = "25" id="givenNickname"></input><br></br>
			UserName: <input size = "25" id="createUsername"></input><br></br>
        	Password: <input size = "25" id="createPassword" type = "password"></input><br></br>
        	Retype Password: <input size = "25" id="createRetypedPassword" type="password"></input><br></br>
        	<button id = "createAccountButton">SUBMIT THE CREATE ACCOUNT BY CLICKING ON ME</button><br></br>
        </div>
        	<div id="signInDiv" style = "display: none">
			Username: <input size = "25" id="signInUsername"></input><br></br>
        	Password: <input size = "25" id="signInPassword" type="password"></input><br></br>
        	<button id = "signInButton">SUBMIT THE SIGN IN BY CLICKING ON ME</button><br></br>
        </div>
        <div id= "hostGameDiv" style = "display: none">
        	Characters In Play -- Space delimited: <input size = "140" id="hostGameCharacters"></input><br></br>
	    	Host Game Name: <input size = "25" id="hostGameStartingID"></input><br></br>
        	Host Game Password: <input size = "25" id="hostGamePassword" type="password"></input><br></br>
        	Retype Host Game Password: <input size = "25" id="hostGameRetypedPassword" type="password"></input></input><br></br>
        	<button id = "hostGameButton">SUBMIT THE HOST GAME BY CLICKING ON ME</button><br></br>
	    </div>
        <div id= "joinGameDiv" style = "display: none">
	    	Game ID: <input size = "25" id="joinGameID"></input><br></br>
        	Game Password: <input size = "25" id="joinGamePassword" type="password"></input><br></br>
        <button id = "joinGameButton">SUBMIT THE JOIN GAME BY CLICKING ON ME</button><br></br>
	    </div>
        <div id = "root"></div>
	    <div id = "root2"></div>
	    <div id = "root3"></div>
	    <div id = "root4"></div>
	    <div id = "root5"></div>
	    <div id = "root6"></div>
	    <div id = "usersReadiedUp" style = "display: none">Number of Players Connected: 1</div>
	    <div id = "areYouReady" style = "display: none">You need to Ready Up!</div>
	    <div id = "readyUpButtonDiv" style = "display: none">
	    	<button id="readyUpButton">Ready Up!</button>
	    	<br></br>
	    </div>
	    <div id = "root7"></div>
	    <div id = "root8"></div>
	    <div id = "root9"></div>
    </body>
</html>